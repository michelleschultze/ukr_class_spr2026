Title: Merging indicators (Ukrstat, )
Author: Michelle Schultze

This script demonstrates how we can merge data from Ukrstat into existing 
long-form datasets. This is very easily adaptable for merging your own 
indicators together!

## Setup

Load in packages
```{r}
library(readxl)
library(dplyr)
library(lubridate)
library(tidyr)
library(readr)
library(stringr)
```

Load in data [originally gathered Sept 18 2025]
```{r}
acled_work_imo_inner_join <- read_excel("Datasets/0 _ Unprocessed datasets/acled_work_imo_inner_join.xlsx")
inflation_data <- read_excel("Datasets/0 _ Unprocessed datasets/dataset_2025-09-18T19_53_38.610113535Z_DEFAULT_INTEGRATION_SSSU_DF_PRICE_CHANGE_CONSUMER_GOODS_SERVICE_LATEST.xlsx")
primary_market_data <- read_excel("Datasets/0 _ Unprocessed datasets/primary market data.xlsx")
secondary_market_data <- read_excel("Datasets/0 _ Unprocessed datasets/secondary market data.xlsx")
```
Inflation data is from Ukrstat. 
Real estate data is from lun.ua.
ACLED data is from ACLED website.
Work data is from work.ua.

Check data
```{r}
head(acled_work_imo_inner_join)
head(inflation_data)
```

## Reshape ACLED dataset (acled_work_imo_inner_join) to long format for easier merging / cleaner organization.

Get list of ACLED columns, which need to be handled differently.
```{r}
acled_cols <- acled_work_imo_inner_join %>%
  select(starts_with("event_type_"), starts_with("sub_event_type_"), starts_with("disorder_type_")) %>%
  names()
```

Because it's the same ACLED datapoint pasted across each of the job categories, 
just take the average of these datapoints to get the correct value. (Could also 
get the median, mode, etc instead.). Then put into long format under the 
"category" variable so we can re-merge.
```{r}
#Summarize across the columns
acled_data <- acled_work_imo_inner_join %>%
  group_by(City, Date, Y, M) %>%
  summarise(
    across(all_of(acled_cols), mean, na.rm = TRUE),
    .groups = "drop"
  )

#Pivot to long
acled_long <- acled_data %>%
  pivot_longer(
    cols = all_of(acled_cols),
    names_to = "Indicator",
    values_to = "Value"
  )
```

Now for the job data, put it in this same format. 
```{r}
job_cols <- c("Job Salary", "Resume Salary", "rate", "Job Salary, USD", "Resume Salary, USD")

job_data <- acled_work_imo_inner_join %>%
  group_by(City, Date, Y, M) %>%
  select(all_of(job_cols), "Category")

# Pivot longer and combine with Category
job_long <- job_data %>%
  pivot_longer(
    cols = all_of(job_cols), 
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(
    Indicator = paste(Indicator, Category, sep = ": ")
  ) %>% 
  # Keep only one exchange rate indicator (e.g., the IT industry version)
  filter(
      str_detect(Indicator, "rate: IT, computers & Internet") |
      !str_detect(Indicator, regex("rate", ignore_case = TRUE))
    ) %>%
  # Remove the industry part and make descriptive
  mutate(
    Indicator = ifelse(
      str_detect(Indicator, "rate: IT, computers & Internet"),
      "Exchange rate (Hrivna to USD, nationally for this month)",
      Indicator
    )
  ) %>%
  select(City, Date, Y, M, Indicator, Value)
```
Also, "Rate" is not descriptive enough. Add details: "Exchange rate (Hrivna to USD)", replacing the word "rate" for any indicator. Then because it's the same across industry datapoints, just keep one. (This is done within the code block above). 

Add source column to both job_long and acled_long
```{r}
job_long <- job_long %>%
  mutate(Source = if_else(str_detect(Indicator, regex("exchange rate", ignore_case = TRUE)),
                          "CB of Ukraine", #exchange rate data is from here, not work.ua.
                          "work.ua"))

acled_long <- acled_long %>%
  mutate(Source = "ACLED")
```

Correct mislabeling of City (work.ua) /Region (ACLED)
```{r}
#Rename relevant city names to be strictly city names and not region names
job_long <- job_long %>%
  mutate(City = recode(City,
                       "Dnipropetrovsk" = "Dnipro",
                       "Kirovohrad" = "Kropyvnytskyi",
                       "Volyn" = "Lutsk",
                       "Zakarpattia" = "Uzhhorod"),
         Region = case_when(
            City == "Cherkasy"        ~ "Cherkaska",
            City == "Chernihiv"       ~ "Chernihivska",
            City == "Chernivtsi"      ~ "Chernivetska",
            City == "Dnipro"  ~ "Dnipropetrovska",
            City == "Donetsk"         ~ "Donetska",
            City == "Ivano-Frankivsk" ~ "Ivano-Frankivska",
            City == "Kharkiv"         ~ "Kharkivska",
            City == "Kherson"         ~ "Khersonska",
            City == "Khmelnytskyi"    ~ "Khmelnytska",
            City == "Kropyvnytskyi"      ~ "Kirovohradska",
            City == "Kyiv"            ~ "Kyivska",
            City == "Lviv"            ~ "Lvivska",
            City == "Mykolaiv"        ~ "Mykolaivska",
            City == "Odesa"           ~ "Odeska",
            City == "Poltava"         ~ "Poltavska",
            City == "Rivne"           ~ "Rivnenska",
            City == "Sumy"            ~ "Sumska",
            City == "Ternopil"        ~ "Ternopilska",
            City == "Vinnytsia"       ~ "Vinnytska",
            City == "Lutsk"           ~ "Volynska",
            City == "Uzhhorod"     ~ "Zakarpatska",
            City == "Zaporizhia"      ~ "Zaporizka",
            City == "Zhytomyr"        ~ "Zhytomyrska"
          ))

#Rename city vector as regions, because that's the unit of analysis for ACLED
acled_long <- acled_long %>%
  mutate(Region = City,
         City = NA,
         Region = case_when(
    Region == "Cherkasy"        ~ "Cherkaska",
    Region == "Chernihiv"       ~ "Chernihivska",
    Region == "Chernivtsi"      ~ "Chernivetska",
    Region == "Dnipropetrovsk"  ~ "Dnipropetrovska",
    Region == "Donetsk"         ~ "Donetska",
    Region == "Ivano-Frankivsk" ~ "Ivano-Frankivska",
    Region == "Kharkiv"         ~ "Kharkivska",
    Region == "Kherson"         ~ "Khersonska",
    Region == "Khmelnytskyi"    ~ "Khmelnytska",
    Region == "Kirovohrad"      ~ "Kirovohradska",
    Region == "Kyiv"            ~ "Kyivska",
    Region == "Lviv"            ~ "Lvivska",
    Region == "Mykolaiv"        ~ "Mykolaivska",
    Region == "Odesa"           ~ "Odeska",
    Region == "Poltava"         ~ "Poltavska",
    Region == "Rivne"           ~ "Rivnenska",
    Region == "Sumy"            ~ "Sumska",
    Region == "Ternopil"        ~ "Ternopilska",
    Region == "Vinnytsia"       ~ "Vinnytska",
    Region == "Volyn"           ~ "Volynska",
    Region == "Zakarpattia"     ~ "Zakarpatska",
    Region == "Zaporizhia"      ~ "Zaporizka",
    Region == "Zhytomyr"        ~ "Zhytomyrska"
  ))
```

Stick them together to complete the reshaping
```{r}
acled_work_imo_inner_join <- bind_rows(job_long, acled_long)

#Sort by City and Date
acled_work_imo_inner_join <- acled_work_imo_inner_join %>%
  arrange(Region, City, Date, Indicator)
```

## Reshape primary and secondary real estate market datasets to long format and merge with ACLED data to form an "ACLED+" dataset.

```{r}
#Secondary market data
secondary_cols <- colnames(secondary_market_data)[!(colnames(secondary_market_data) %in% c("...1", "city", "date"))]

secondary_long <- secondary_market_data %>%
  rename(City = city, Date = date) %>%
  mutate(
    Y = year(Date),
    M = month(Date)
  ) %>%
  pivot_longer(
    cols = all_of(secondary_cols),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  # Optionally, clean the indicator names
  mutate(
    Indicator = paste0("Secondary Market: ", Indicator)
  ) %>%
  select(City, Date, Y, M, Indicator, Value)


#Primary market data
primary_cols <- colnames(primary_market_data)[!(colnames(primary_market_data) %in% c("...1", "city", "date"))]

primary_long <- primary_market_data %>%
  rename(City = city, Date = date) %>%
  mutate(
    Y = year(Date),
    M = month(Date)
  ) %>%
  pivot_longer(
    cols = all_of(primary_cols),
    names_to = "Indicator",
    values_to = "Value"
  ) %>%
  mutate(
    Indicator = paste0("Primary Market: ", Indicator)
  ) %>%
  select(City, Date, Y, M, Indicator, Value)


#Get real estate market data into one long set ready to merge
market_long <- bind_rows(primary_long, secondary_long) %>%
  mutate(Source = "lun.ua")
```

Check to make sure the cities are correct
```{r}
unique(market_long$City)
#They exactly match. Now give them regions.

#Rename relevant city names to be strictly city names and not region names
market_long <- market_long %>%
  mutate(Region = case_when(
            City == "Cherkasy"        ~ "Cherkaska",
            City == "Chernihiv"       ~ "Chernihivska",
            City == "Chernivtsi"      ~ "Chernivetska",
            City == "Chernivitsi"      ~ "Chernivetska", #alternate spelling
            City == "Dnipro"  ~ "Dnipropetrovska",
            City == "Donetsk"         ~ "Donetska",
            City == "Ivano-Frankivsk" ~ "Ivano-Frankivska",
            City == "Kharkiv"         ~ "Kharkivska",
            City == "Kherson"         ~ "Khersonska",
            City == "Khmelnytskyi"    ~ "Khmelnytska",
            City == "Khelmnytskyi"    ~ "Khmelnytska", #alternate spelling
            City == "Kropyvnytskyi"      ~ "Kirovohradska",
            City == "Kyiv"            ~ "Kyivska",
            City == "Lviv"            ~ "Lvivska",
            City == "Mykolaiv"        ~ "Mykolaivska",
            City == "Odesa"           ~ "Odeska",
            City == "Poltava"         ~ "Poltavska",
            City == "Rivne"           ~ "Rivnenska",
            City == "Sumy"            ~ "Sumska",
            City == "Ternopil"        ~ "Ternopilska",
            City == "Vinnytsia"       ~ "Vinnytska",
            City == "Lutsk"           ~ "Volynska",
            City == "Uzhhorod"     ~ "Zakarpatska",
            City == "Zaporizhia"      ~ "Zaporizka",
            City == "Zaporizhzhia"      ~ "Zaporizka", #alternate spelling
            City == "Zhytomyr"        ~ "Zhytomyrska"
          ))
```

Bind rows to make ACLED+ dataset (keeping same name for now).
```{r}
# Combine job_long and acled_long
acled_work_imo_inner_join <- bind_rows(acled_work_imo_inner_join, market_long)
```

## Filter for timeframe/indicators of interest.

Filter for indicators that have no NAs for the time window of interest: 2021-2024
```{r}
# Vector of monthly columns for 2022-2024
months_2021_2024 <- c(
  paste0("2021-M", sprintf("%02d", 1:12)),
  paste0("2022-M", sprintf("%02d", 1:12)),
  paste0("2023-M", sprintf("%02d", 1:12)),
  paste0("2024-M", sprintf("%02d", 1:12))
)

# Filter indicators that have non-missing data for all months
monthly_indicators_2021_24 <- inflation_data %>%
  filter(Frequency == "Monthly") %>%
  filter(if_all(all_of(months_2021_2024), ~ !is.na(.)))

unique(monthly_indicators_2021_24$`Type of goods and services`)
```

Specify the goods we care about (very easy to trade out for other goods):
```{r}
price_indicators <- c(
  # Food & Staples
  "Poultry (chicken carcasses)",
  "Milk formulas for baby food",
  "Eggs",
  "Potato",
  "Rice",
  "Butter",
  "Sunflower oil",
  "Beef",
  "Pork",
  "Beets",
  "Fish",
  "Milk",
  "Sugar",
  "Apples",
  
  # Energy & Transport
  "Petrol A-92",
  
  # Housing & Utilities
  "Electricity",
  
  # Health & Pharmaceuticals
  
  # Optional / Discretionary
  "Cigarettes with a medium class filter"
)
```

Filter for those goods.
```{r}
inflation_indicators_fulldata <- monthly_indicators_2021_24 %>%
  filter(`Type of goods and services` %in% price_indicators)

unique(inflation_indicators_fulldata$`Type of goods and services`)
```

Also filter for non-NA times. [results: Jan 2017-Aug 2025]
```{r}
inflation_indicators_fulldata <- inflation_indicators_fulldata %>%
  select(where(~ !any(is.na(.))))
```

## Reshape to standardized format 

Get a list of all of our time columns
```{r}
time_columns <- inflation_indicators_fulldata %>%
  select(matches("^\\d{4}-M\\d{2}$")) %>%
  names()
```

Reshape to match 
```{r}
inflation_indicators_reshape <- inflation_indicators_fulldata %>%
  pivot_longer(
    cols = all_of(time_columns),
    names_to = "Date",
    values_to = "Price level"
  ) %>%
  rename(Category = `Type of goods and services`) %>%
  mutate(
    Date = ym(gsub("-M", "-", Date)),
    Date = as_datetime(Date),
    Y = year(Date),
    M = month(Date)
  ) %>%
  select(Category, Region, Date, `Price level`, Y, M, `Unit of measure`)
```

Match column structure by adding a standardized "Indicator" column
```{r}
inflation_indicators_reshape <- inflation_indicators_reshape %>%
  mutate(
    Indicator = paste0("Price Level: ", Category, " (per ", `Unit of measure`, ")"),
    City = NA,
    Source = "Ukrstat") %>%
  rename(Value = `Price level`)  %>%
  select(City, Date, Y, M, Indicator, Value, Source, Region)
```

```{r}
# Combine job_long and acled_long
MASTER_DATASET <- bind_rows(acled_work_imo_inner_join, inflation_indicators_reshape)

# Optional: sort by City and Date
MASTER_DATASET <- MASTER_DATASET %>%
  arrange(City, Date, Indicator)
```


## Export with timestamp.

```{r}
write_csv(MASTER_DATASET, "Datasets/1 _ Merged datasets/Fulldata_City_Region_Monthly_Nov052025.csv")
```

